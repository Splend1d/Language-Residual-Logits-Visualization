<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Combined Sentence with Side-by-Side Candidates</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  .audio-id-btn {
    margin: 3px 4px 10px 0;
    padding: 6px 12px;
    cursor: pointer;
    border-radius: 6px;
    border: 1.5px solid #4285f4;
    background-color: white;
    color: #4285f4;
    font-weight: 600;
    user-select: none;
  }
  .audio-id-btn.selected {
    background-color: #4285f4;
    color: white;
  }
  #sentence {
    margin-bottom: 20px;
    max-width: 90vw;
    word-wrap: break-word;
    font-size: 1.4rem; /* larger font */
  }
  .word {
    cursor: pointer;
    padding: 3px 6px;
    border-radius: 4px;
    margin-right: 4px;
    user-select: none;
  }
  .word:hover {
    background-color: #ddd;
  }
  .selected {
    background-color: #a0d3ff;
  }
  #candidates-container {
    display: flex;
    gap: 30px;
    flex-wrap: wrap;
    max-width: 900px;
  }
  .candidates-panel {
    flex: 1 1 45%;
    border: 1px solid #ccc;
    padding: 12px;
    border-radius: 8px;
    white-space: normal;
    min-height: 150px;
  }
  .candidates-panel h3 {
    margin-top: 0;
    color: #1a73e8;
  }
  .candidate {
    margin: 2px 0;
  }
  .candidate-bar {
    display: inline-block;
    height: 14px;
    background-color: #4285f4;
    vertical-align: middle;
  }
  .candidate-text {
    margin-left: 6px;
    vertical-align: middle;
  }
  .no-data {
    font-style: italic;
    color: #999;
  }
</style>
</head>
<body>

<h1>Combined Sentence with Side-by-Side Candidates</h1>

<div id="audioIdButtons"></div>

<div id="sentence">Loading data...</div>

<div id="candidates-container">
  <div class="candidates-panel" id="candidates-whisper">
    <h3>whisper-large-v3.jsonl Candidates</h3>
    <div><em>Click a word above to see candidates here.</em></div>
  </div>
  <div class="candidates-panel" id="candidates-phi4">
    <h3>phi4.jsonl Candidates</h3>
    <div><em>Click a word above to see candidates here.</em></div>
  </div>
</div>

<script>
const FILES = [
  {name: "whisper-large-v3.jsonl", shortName: "whisper-large-v3"},
  {name: "phi4-multimodal.jsonl", shortName: "phi4"},
];

// Data maps keyed by audio_id, each is array of word entries sorted by target_id
const dataMaps = {
  "whisper-large-v3": new Map(),
  "phi4": new Map()
};

const audioIdsSet = new Set();

function fetchFile(fileInfo) {
  return fetch(fileInfo.name)
    .then(res => {
      if (!res.ok) throw new Error(`HTTP error ${res.status} for ${fileInfo.name}`);
      return res.text();
    })
    .then(text => {
      const lines = text.split('\n').filter(l => l.trim());
      lines.forEach(line => {
        try {
          const obj = JSON.parse(line);
          const id = obj.audio_id;
          audioIdsSet.add(id);
          if (!dataMaps[fileInfo.shortName].has(id))
            dataMaps[fileInfo.shortName].set(id, []);
          dataMaps[fileInfo.shortName].get(id).push(obj);
        } catch(e) {
          console.warn(`Skipping invalid JSON in ${fileInfo.name}:`, line);
        }
      });
    });
}

Promise.all(FILES.map(fetchFile))
  .then(() => {
    if (audioIdsSet.size === 0) {
      document.getElementById("sentence").textContent = "No valid data found.";
      return;
    }
    const audioIds = Array.from(audioIdsSet).sort();

    renderAudioIdButtons(audioIds);

    // Show first audio id by default
    renderSentence(audioIds[0]);
  })
  .catch(err => {
    document.getElementById("sentence").textContent = "Error loading data: " + err.message;
  });

function renderAudioIdButtons(audioIds) {
  const container = document.getElementById("audioIdButtons");
  container.innerHTML = "";
  audioIds.forEach((id, idx) => {
    const btn = document.createElement("button");
    btn.textContent = id;
    btn.className = "audio-id-btn";
    if (idx === 0) btn.classList.add("selected");
    btn.addEventListener("click", () => {
      document.querySelectorAll(".audio-id-btn").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      renderSentence(id);
    });
    container.appendChild(btn);
  });
}

function renderSentence(audioId) {
  // Get both arrays, or empty array if missing
  const arrWhisper = dataMaps["whisper-large-v3"].get(audioId) || [];
  const arrPhi4 = dataMaps["phi4"].get(audioId) || [];

  // Build map by target_id for quick lookup
  const mapWhisper = new Map(arrWhisper.map(d => [d.target_id, d]));
  const mapPhi4 = new Map(arrPhi4.map(d => [d.target_id, d]));

  // Get union of target_ids
  const allTargetIds = Array.from(new Set([...mapWhisper.keys(), ...mapPhi4.keys()])).sort((a,b) => a-b);

  const sentenceDiv = document.getElementById("sentence");
  const candWhisperDiv = document.getElementById("candidates-whisper");
  const candPhi4Div = document.getElementById("candidates-phi4");

  sentenceDiv.innerHTML = `<strong>Audio ID: ${audioId}</strong><br/>`;

  allTargetIds.forEach(tid => {
    // Prefer whisper if available, else phi4
    let wordData = mapWhisper.get(tid) || mapPhi4.get(tid);
    if (!wordData) {
      // unlikely, but just skip word if missing in both
      return;
    }
    const span = document.createElement("span");
    span.textContent = wordData.target_text + " ";
    span.className = "word";
    span.title = `Click to see candidates for "${wordData.target_text.trim()}"`;

    span.addEventListener("click", () => {
      // Remove previously selected word
      document.querySelectorAll("#sentence .word").forEach(w => w.classList.remove("selected"));
      span.classList.add("selected");

      // Show candidates side-by-side
      showCandidatesForTargetId(audioId, tid);
    });

    sentenceDiv.appendChild(span);
  });

  candWhisperDiv.querySelector("div")?.remove();
  candPhi4Div.querySelector("div")?.remove();

  candWhisperDiv.innerHTML = `<h3>whisper-large-v3.jsonl Candidates</h3><em>Click a word above to see candidates here.</em>`;
  candPhi4Div.innerHTML = `<h3>phi4.jsonl Candidates</h3><em>Click a word above to see candidates here.</em>`;
}

function showCandidatesForTargetId(audioId, targetId) {
  const candWhisperDiv = document.getElementById("candidates-whisper");
  const candPhi4Div = document.getElementById("candidates-phi4");

  const whisperEntry = (dataMaps["whisper-large-v3"].get(audioId) || []).find(d => d.target_id === targetId);
  const phi4Entry = (dataMaps["phi4"].get(audioId) || []).find(d => d.target_id === targetId);

  function renderCandidates(entry, container) {
    container.innerHTML = ""; // clear
    if (!entry) {
      container.innerHTML = `<h3>${container.id === "candidates-whisper" ? "whisper-large-v3.jsonl" : "phi4.jsonl"} Candidates</h3><p class="no-data">No data for this word.</p>`;
      return;
    }
    container.innerHTML = `<h3>${container.id === "candidates-whisper" ? "whisper-large-v3.jsonl" : "phi4.jsonl"} â€” Candidates for word <em>"${entry.target_text.trim()}"</em> (position ${entry.target_id}):</h3>`;

    const sortedCandidates = Object.entries(entry.candidates)
      .filter(([cand]) => cand.trim() !== "")
      .sort((a,b) => b[1] - a[1]);

    const maxProb = sortedCandidates.length > 0 ? sortedCandidates[0][1] : 1;

    sortedCandidates.forEach(([candidate, prob]) => {
      const candDiv = document.createElement("div");
      candDiv.className = "candidate";
      const bar = document.createElement("span");
      bar.className = "candidate-bar";
      bar.style.width = `${(prob / maxProb) * 200}px`;
      candDiv.appendChild(bar);

      const textSpan = document.createElement("span");
      textSpan.className = "candidate-text";
      textSpan.textContent = `${candidate} : ${(prob*100).toFixed(2)}%`;
      candDiv.appendChild(textSpan);

      container.appendChild(candDiv);
    });

    if(sortedCandidates.length === 0) {
      container.innerHTML += "<p>No candidate probabilities available.</p>";
    }
  }

  renderCandidates(whisperEntry, candWhisperDiv);
  renderCandidates(phi4Entry, candPhi4Div);
}
</script>

</body>
</html>
